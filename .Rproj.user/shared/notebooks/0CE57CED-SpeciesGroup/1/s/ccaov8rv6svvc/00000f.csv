"0","dat <- data_2022"
"0","dat$ibra_region[is.na(dat$ibra_region) | dat$ibra_region == """"] <- ""Unknown"""
"0",""
"0","# Sum occurrences per region"
"0","reg_counts <- aggregate(occurrence_count ~ ibra_region, data = dat, sum, na.rm = TRUE)"
"0","reg_counts <- reg_counts[order(reg_counts$occurrence_count, decreasing = TRUE), ]"
"0",""
"0","# Keep Top-10 and group the rest as ""Other"""
"0","top_n <- 10"
"0","n <- nrow(reg_counts)"
"0","top_df <- reg_counts[seq_len(min(top_n, n)), ]"
"0","other_sum <- if (n > top_n) sum(reg_counts$occurrence_count[(top_n + 1):n]) else 0"
"0","plot_df <- if (n > top_n) rbind(top_df, data.frame(ibra_region = ""Other"","
"0","                                                   occurrence_count = other_sum)) else top_df"
"0",""
"0","# Percent labels"
"0","plot_df$pct <- plot_df$occurrence_count / sum(plot_df$occurrence_count)"
"0","plot_df$label <- paste0(sprintf(""%.1f"", plot_df$pct * 100), ""%"")"
"0",""
"0","# Order slices largest -> smallest"
"0","plot_df$ibra_region <- factor(plot_df$ibra_region,"
"0","                              levels = plot_df$ibra_region[order(plot_df$occurrence_count, decreasing = TRUE)])"
"0",""
"0","# Donut pie"
"0","ggplot(plot_df, aes(x = 2, y = occurrence_count, fill = ibra_region)) +"
"0","  geom_col(color = ""white"") +"
"0","  coord_polar(theta = ""y"") +"
"0","  xlim(0.5, 2.5) +  # hole"
"0","  geom_text(aes(label = label), position = position_stack(vjust = 0.5), size = 3) +"
"0","  labs(title = ""IBRA regions - share of total occurrences (cleaned data)"","
"0","       subtitle = ""Top 10 regions shown. Others grouped as 'Other'"","
"0","       fill = ""IBRA region"") +"
"0","  theme_void(base_size = 12)"
"0",""
